---
name: Integration with Chat & Memory Flows
status: open
created: 2025-10-14T03:28:21Z
updated: 2025-10-14T03:44:38Z
github: https://github.com/tgarrochinho/lumara-frontend/issues/18
depends_on: [001, 002, 003, 004, 005]
parallel: false
conflicts_with: []
---

# Task: Integration with Chat & Memory Flows

## Description
Wire the AI infrastructure into existing chat and memory creation flows. Enable end-to-end functionality: user types message → AI responds → embedding generated → similarity checked → memory stored.

## Acceptance Criteria
- [ ] Chat UI uses AI provider for responses
- [ ] Embeddings generated automatically for new memories
- [ ] Contradiction detection runs before memory creation
- [ ] Duplicate detection warns user
- [ ] Memory stored with embedding in Dexie
- [ ] Full flow works end-to-end
- [ ] Error handling at each step
- [ ] Loading states during AI operations

## Technical Details

### Files to Create/Modify
```
src/components/chat/
├── ChatInterface.tsx        # Main chat component (modify)
└── MemoryCreationFlow.tsx   # New memory flow

src/hooks/
├── useChat.ts               # Chat logic hook
└── useMemoryCreation.ts     # Memory creation hook
```

### Implementation

1. **useChat Hook** (`src/hooks/useChat.ts`)
```typescript
import { useState } from 'react';
import { useAIStatus } from './useAIStatus';

export interface ChatMessage {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp: Date;
}

export function useChat() {
  const { provider, status } = useAIStatus();
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [isLoading, setIsLoading] = useState(false);

  const sendMessage = async (content: string) => {
    if (!provider || status !== 'ready') {
      throw new Error('AI not ready');
    }

    // Add user message
    const userMessage: ChatMessage = {
      id: Date.now().toString(),
      role: 'user',
      content,
      timestamp: new Date(),
    };

    setMessages(prev => [...prev, userMessage]);
    setIsLoading(true);

    try {
      // Get AI response
      const response = await provider.chat(content, [
        // Optionally include context from previous messages
      ]);

      // Add assistant message
      const assistantMessage: ChatMessage = {
        id: (Date.now() + 1).toString(),
        role: 'assistant',
        content: response,
        timestamp: new Date(),
      };

      setMessages(prev => [...prev, assistantMessage]);
    } catch (error) {
      console.error('Chat error:', error);
      throw error;
    } finally {
      setIsLoading(false);
    }
  };

  return {
    messages,
    sendMessage,
    isLoading,
  };
}
```

2. **useMemoryCreation Hook** (`src/hooks/useMemoryCreation.ts`)
```typescript
import { useState } from 'react';
import { generateEmbedding } from '@/lib/ai/embeddings/transformers';
import { detectContradictions, detectDuplicates } from '@/lib/ai/utils/contradiction';
import { saveMemoryWithEmbedding, getMemoriesWithEmbeddings } from '@/lib/db';
import { useAIStatus } from './useAIStatus';

export interface MemoryCreationOptions {
  content: string;
  type: 'knowledge' | 'experience' | 'method';
  tags?: string[];
}

export interface ContradictionWarning {
  exists: boolean;
  contradictions: any[];
}

export interface DuplicationWarning {
  exists: boolean;
  duplicates: any[];
}

export function useMemoryCreation() {
  const { provider } = useAIStatus();
  const [isCreating, setIsCreating] = useState(false);
  const [contradiction, setContradiction] = useState<ContradictionWarning | null>(null);
  const [duplication, setDuplication] = useState<DuplicationWarning | null>(null);

  const checkForIssues = async (content: string) => {
    // Generate embedding
    const embedding = await generateEmbedding(content);

    // Get existing memories
    const existingMemories = await getMemoriesWithEmbeddings();

    // Check for contradictions
    if (provider) {
      const contradictions = await detectContradictions(
        'new-memory',
        content,
        embedding,
        existingMemories,
        provider
      );

      setContradiction({
        exists: contradictions.length > 0,
        contradictions,
      });
    }

    // Check for duplicates
    const duplicates = await detectDuplicates(
      embedding,
      existingMemories,
      0.85
    );

    setDuplication({
      exists: duplicates.length > 0,
      duplicates,
    });

    return { embedding, hasIssues: contradictions.length > 0 || duplicates.length > 0 };
  };

  const createMemory = async (options: MemoryCreationOptions, embedding: number[]) => {
    setIsCreating(true);

    try {
      const memoryId = await saveMemoryWithEmbedding(
        {
          content: options.content,
          type: options.type,
          tags: options.tags || [],
        },
        embedding
      );

      setContradiction(null);
      setDuplication(null);

      return memoryId;
    } finally {
      setIsCreating(false);
    }
  };

  return {
    checkForIssues,
    createMemory,
    isCreating,
    contradiction,
    duplication,
  };
}
```

3. **ChatInterface Component** (`src/components/chat/ChatInterface.tsx`)
```typescript
import { useState } from 'react';
import { useChat } from '@/hooks/useChat';
import { useMemoryCreation } from '@/hooks/useMemoryCreation';
import { AIStatus } from '../ai/AIStatus';

export function ChatInterface() {
  const { messages, sendMessage, isLoading } = useChat();
  const { checkForIssues, createMemory, contradiction, duplication } = useMemoryCreation();
  const [input, setInput] = useState('');
  const [showMemoryPrompt, setShowMemoryPrompt] = useState(false);

  const handleSend = async () => {
    if (!input.trim()) return;

    try {
      await sendMessage(input);
      setInput('');

      // After AI response, ask if user wants to save as memory
      setShowMemoryPrompt(true);
    } catch (error) {
      console.error('Send error:', error);
    }
  };

  const handleSaveMemory = async () => {
    const lastMessage = messages[messages.length - 1];

    if (!lastMessage) return;

    // Check for contradictions/duplicates
    const { embedding, hasIssues } = await checkForIssues(lastMessage.content);

    if (hasIssues) {
      // Show warnings, let user decide
      return;
    }

    // Save memory
    await createMemory(
      {
        content: lastMessage.content,
        type: 'knowledge',
      },
      embedding
    );

    setShowMemoryPrompt(false);
  };

  return (
    <div className="chat-interface">
      <div className="chat-header">
        <h2>Chat with Lumara</h2>
        <AIStatus />
      </div>

      <div className="chat-messages">
        {messages.map(message => (
          <div key={message.id} className={`message message-${message.role}`}>
            {message.content}
          </div>
        ))}

        {isLoading && <div className="message-loading">Thinking...</div>}
      </div>

      {showMemoryPrompt && (
        <div className="memory-prompt">
          <p>Save this as a memory?</p>
          <button onClick={handleSaveMemory}>Yes, Save</button>
          <button onClick={() => setShowMemoryPrompt(false)}>No</button>
        </div>
      )}

      {contradiction?.exists && (
        <div className="contradiction-warning">
          ⚠️ This contradicts {contradiction.contradictions.length} existing memory(ies)
        </div>
      )}

      {duplication?.exists && (
        <div className="duplication-warning">
          ⚠️ Similar memory already exists
        </div>
      )}

      <div className="chat-input">
        <input
          type="text"
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onKeyDown={(e) => e.key === 'Enter' && handleSend()}
          placeholder="Type a message..."
          disabled={isLoading}
        />
        <button onClick={handleSend} disabled={isLoading}>
          Send
        </button>
      </div>
    </div>
  );
}
```

### Integration Flow
```
1. User types message
2. AI provider generates response
3. Response displayed in chat
4. Option to save as memory
5. If save:
   a. Generate embedding
   b. Check contradictions
   c. Check duplicates
   d. Show warnings if found
   e. User confirms
   f. Save to Dexie with embedding
```

## Dependencies
- [ ] Tasks 001-005 must be complete
- [ ] Existing chat UI (if exists)

## Effort Estimate
- **Size:** L (Large)
- **Hours:** 14-18 hours
- **Parallel:** No - Depends on all previous tasks

## Definition of Done
- [ ] Chat works with AI provider
- [ ] Memory creation flow complete
- [ ] Contradiction detection integrated
- [ ] Duplicate detection integrated
- [ ] Error handling comprehensive
- [ ] Loading states appropriate
- [ ] Integration tests passing
- [ ] Manual testing successful
