---
name: Set Up Data Fetching Layer (TanStack Query)
status: open
created: 2025-10-13T19:38:52Z
updated: 2025-10-13T19:44:05Z
github: https://github.com/tgarrochinho/lumara-frontend/issues/8
depends_on: [6, 7]
parallel: false
conflicts_with: []
---

# Task: Set Up Data Fetching Layer (TanStack Query)

## Description

Install and configure TanStack Query (React Query) for data fetching and caching. Create the QueryClient configuration file and wrap the App with QueryClientProvider. Create an example query hook that uses Dexie to demonstrate the integration pattern. Verify that query caching and updates work correctly.

TanStack Query provides automatic caching, background refetching, and optimistic updates even for local IndexedDB data. This creates a consistent data fetching pattern whether data comes from IndexedDB or (future) API calls.

## Acceptance Criteria

- [ ] @tanstack/react-query installed and saved to package.json
- [ ] `src/lib/query.ts` created with QueryClient configuration
- [ ] App.tsx wrapped with QueryClientProvider
- [ ] Example query hook created that reads from Dexie
- [ ] Query caching verified (data persists between component mounts)
- [ ] Query invalidation/refetching works
- [ ] DevTools configured for debugging (optional but recommended)
- [ ] No console errors related to React Query

## Technical Details

**Installation:**
```bash
npm install @tanstack/react-query
npm install @tanstack/react-query-devtools --save-dev
```

**File to create:** `src/lib/query.ts`

**Required elements:**
- Import QueryClient, QueryClientProvider
- Create and configure QueryClient with sensible defaults
- Export QueryClient instance
- Configure default options (staleTime, cacheTime, retry, etc.)

**Example structure:**
```typescript
import { QueryClient } from '@tanstack/react-query';

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 60 * 5, // 5 minutes
      cacheTime: 1000 * 60 * 30, // 30 minutes
      refetchOnWindowFocus: false,
      retry: 1,
    },
  },
});
```

**App.tsx changes:**
```typescript
import { QueryClientProvider } from '@tanstack/react-query';
import { queryClient } from '@/lib/query';

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      {/* Your app */}
    </QueryClientProvider>
  );
}
```

**Example query hook (using Dexie):**
Create a simple hook that demonstrates the pattern:
```typescript
// src/hooks/useExampleQuery.ts
import { useQuery } from '@tanstack/react-query';
import { db } from '@/lib/db';

export function useExampleQuery() {
  return useQuery({
    queryKey: ['example'],
    queryFn: async () => {
      // Example: read from Dexie
      return { message: 'Query working!' };
    },
  });
}
```

**Optional DevTools setup:**
```typescript
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';

// Add in App.tsx
<ReactQueryDevtools initialIsOpen={false} />
```

**Validation steps:**
1. Import and use example query hook in a component
2. Verify data loads and displays
3. Check React Query DevTools (if configured)
4. Unmount and remount component - data should come from cache
5. Test query invalidation triggers refetch

## Dependencies

- [ ] Task 004 (Dexie setup) must be complete to create integration example
- [ ] Task 005 (Zustand setup) must be complete (to understand state patterns)
- [ ] Task 002 (TypeScript configuration) for proper typing
- [ ] React 19 installed
- [ ] Vite dev server can run

## Effort Estimate

- Size: S
- Hours: 3 hours
- Parallel: false (depends on Dexie and Zustand being set up first)

**Breakdown:**
- Installation: 15 minutes
- Create query.ts configuration: 45 minutes
- Wrap App with provider: 15 minutes
- Create example query hook using Dexie: 1 hour
- Testing caching and updates: 45 minutes
- Documentation comments: 15 minutes

## Definition of Done

- [ ] Code implemented and follows TypeScript strict mode
- [ ] QueryClient configured and exported from src/lib/query.ts
- [ ] App wrapped with QueryClientProvider
- [ ] Example query hook demonstrates Dexie integration
- [ ] Can use useQuery hooks in components without errors
- [ ] Query caching verified (check DevTools or test behavior)
- [ ] Query invalidation triggers refetch correctly
- [ ] Code has JSDoc comments explaining usage pattern
- [ ] No TypeScript errors (npm run type-check passes)
- [ ] No console errors when dev server runs
- [ ] Git commit made with clear message
